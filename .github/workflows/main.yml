name: rustdesk

on:
  workflow_dispatch:

jobs:
  remote-desktop:
    runs-on: ubuntu-latest

    steps:
      - name: Install desktop environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xorg dbus-x11 xrdp x11-xserver-utils xvfb \
            imagemagick scrot
      - name: Start virtual display with XFCE
        run: |
          echo "Starting Xvfb virtual display :0 with XFCE4..."
          Xvfb :0 -screen 0 1024x768x24 &
          export DISPLAY=:0
          nohup startxfce4 >/dev/null 2>&1 &
          sleep 5
          echo "XFCE4 desktop started on DISPLAY=:0"
      

      - name: Set password for runner
        run: |
          echo "runner:123456" | sudo chpasswd
          echo "Password for user 'runner' set to 123456"
      - name: Start xrdp service
        run: |
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo systemctl status xrdp --no-pager
      - name: Install RustDesk
        run: |
          wget https://github.com/rustdesk/rustdesk/releases/download/1.4.2/rustdesk-1.4.2-x86_64.deb -O rustdesk.deb
          sudo apt-get update
          sudo apt-get install -y ./rustdesk.deb || sudo apt-get install -f -y
      - name: Start virtual display with XFCE
        run: |
          echo "Starting Xvfb virtual display :0 with XFCE4..."
          Xvfb :0 -screen 0 1024x768x24 &
          export DISPLAY=:0
          nohup startxfce4 >/dev/null 2>&1 &
          sleep 5
          echo "XFCE4 desktop started on DISPLAY=:0"
      - name: Ensure rustdesk data dir exists
        run: |
          sudo mkdir -p /var/lib/rustdesk
          sudo chown -R runner:runner /var/lib/rustdesk || true
      - name: Start RustDesk (service or fallback)
        run: |
          sudo systemctl enable rustdesk.service >/dev/null 2>&1 || true
          sudo systemctl start rustdesk.service >/dev/null 2>&1 || true
          DISPLAY=:0 rustdesk &
          if ! systemctl is-active --quiet rustdesk.service 2>/dev/null; then
            echo "RustDesk systemd service not active â€” starting rustdesk binary in background"
            sudo -u runner bash -c 'nohup rustdesk >/dev/null 2>&1 &'
          fi
      - name: Set password for RustDesk
        run: |
          sudo mkdir -p /var/lib/rustdesk
          echo "123456" | sudo tee /var/lib/rustdesk/passwd >/dev/null
          sudo chown runner:runner /var/lib/rustdesk/passwd || true
          echo "Password set to 123456"
      - name: Take screenshot of XFCE desktop
        run: |
          export DISPLAY=:0
          mkdir -p screenshots
          sleep 120
          scrot "screenshots/screen-$(date +%s).png"
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-screenshot
          path: screenshots/*.png


      - name: Keep alive until cancelled
        run: |
          echo "Remote desktop is running!"
          echo "User: runner"
          echo "Password: 123456"
          echo "Cancel workflow to stop."
          while true; do
            echo "[KEEP-ALIVE] Workflow still running at $(date -u)";
            sleep 300;
          done
